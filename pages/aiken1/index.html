<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>Aiken for Amateurs | Piefayth's Blog</title><meta property="og:title" content="Aiken for Amateurs | Piefayth's Blog"><meta name=twitter:title content="Aiken for Amateurs | Piefayth's Blog"><meta itemprop=name content="Aiken for Amateurs | Piefayth's Blog"><meta name=application-name content="Aiken for Amateurs | Piefayth's Blog"><meta property="og:site_name" content><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><meta property="og:locale" content="en-us"><meta name=language content="en-us"><meta itemprop=image content="https://piefayth.github.io/blog/"><meta property="og:image" content="https://piefayth.github.io/blog/"><meta name=twitter:image content="https://piefayth.github.io/blog/"><meta name=twitter:image:src content="https://piefayth.github.io/blog/"><meta name=generator content="Hugo 0.110.0"><link rel=canonical href=https://piefayth.github.io/blog/pages/aiken1/><link href=/blog/style.min.79ee4530e2218018d2c114e16552697a0e232ecbf3214e8103a24d37cf0225b3.css rel=stylesheet><link href=/blog/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/blog/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/blog/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/blog/icons/favicon-16x16.png><link rel=mask-icon href=/blog/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/blog/favicon.ico><link rel=manifest href=https://piefayth.github.io/blog/site.webmanifest><meta name=msapplication-config content="/blog/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/blog/icons/favicon.svg></head><body data-theme class=notransition><script src=/blog/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://piefayth.github.io/blog/ class=logo><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>Aiken for Amateurs</h1><div class=post-meta><time datetime=2023-08-27T00:00:00+00:00 itemprop=datePublished>Aug 27, 2023</time></div></header><div class=page-content><p>After a couple weeks of research on Cardano, I still struggled to visualize what I could build with smart contracts. The relationship between minting policies and spending validators was unclear, the bridge between Aiken and Lucid seemed complicated, and worst of all, I couldn&rsquo;t figure out where to keep my application state! This is my attempt at the introduction I would&rsquo;ve liked to have had myself.</p><h2 id=prerequisites>Prerequisites</h2><p>This article assumes you have completed the Aiken &ldquo;Hello, World&rdquo; tutorial and have read the Cardano developer documentation. Familiarity with native tokens, wallets, addresses, and off-chain infrastructure (e.g. chain indexes) is expected. All the examples within are Deno + TypeScript + Lucid + Aiken. Your environment should be configured to support that.</p><p>Some of the imports and boilerplate have been removed from the examples below. Complete, runnable examples are available in <a href=https://github.com/Piefayth/aiken-blog-1-code/tree/main>the companion repo to this article</a>.</p><h2 id=smart-contracts>Smart Contracts</h2><p>Smart contracts on Cardano are <em>validators</em>. A smart contract is unable to take any action on its own; it can only approve or deny proposed transactions. A smart contract cannot &ldquo;send tokens&rdquo; or &ldquo;call another contract.&rdquo; The contract must introspect the incoming transaction and verify that it does those things. There are four kinds of contracts, but we&rsquo;ll focus on the two that power most decentralized applications: minting policies and spending validators.</p><ul><li><strong>Minting Policy</strong>: If a transaction intends to <em>mint</em> new tokens or <em>burn</em> existing tokens, it requires the approval of that token&rsquo;s minting policy to do so.</li><li><strong>Spending Validator</strong>: If a transaction intends to spend tokens from a contract address, it requires the approval of that address&rsquo;s spending validator.</li></ul><p>A contract is identified by a hash of itself. In the case of a minting policy, the hash of the code of the contract is the policy id of the native token that it mints. If you have a token with a particular policy id, it is guaranteed to have been minted by the minting policy that policy id was derived from. If the code of that minting policy were anything else, the resultant policy id would differ, and it <em>could not</em> produce the &ldquo;same&rdquo; token. In a similar fashion, for the spending validator, the hash of the code of the contract is (effectively) the address that the contract resides at. In the Aiken &ldquo;Hello, World&rdquo; tutorial, looking up the resultant transaction on an indexing service reveals this; there is already a long history of transactions at the contract address you just &ldquo;made&rdquo;! Same code? Same contract.</p><p>Contracts have limited ability to &ldquo;look up&rdquo; on-chain data. When submitting a transaction, nearly all of the data must be provided by the caller. For a single transaction, this includes</p><ul><li><strong>inputs</strong>: What unspent transaction outputs are being spent?</li><li><strong>outputs</strong>: What new utxos are being created?</li><li><strong>mint</strong>: What tokens were minted and burned?</li><li><strong>signatories</strong>: Who signed it?</li><li><strong>datums</strong>: The data stored alongside a utxo on-chain.</li><li><strong>redeemers</strong>: The arguments to a minting policy or spending validator.</li></ul><blockquote><p>Note that there is also <strong>metadata</strong>. Metadata is data stored on-chain that is <em>not available in contracts</em>. A transaction can put metadata on any utxo, but that metadata cannot be consumed by a contract.</p></blockquote><p>Every minting policy and spending validator has access to these fields. Some are self-explanatory, but two deserve special attention, <em>datum</em> and <em>redeemer</em>.</p><h2 id=minting-policies--redeemers>Minting Policies & Redeemers</h2><p>Let&rsquo;s introduce minting policies and redeemers with an example. Here is the simplest possible minting policy in Aiken. We know it&rsquo;s a minting policy because it <em>only</em> takes a redeemer - not a datum.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#89dceb>use</span> <span style=color:#b4befe>aiken</span><span style=color:#89dceb>/</span><span style=color:#b4befe>transaction</span><span style=color:#89dceb>.</span><span style=color:#cdd6f4>{</span><span style=color:#f9e2af>ScriptContext</span><span style=color:#cdd6f4>,</span> <span style=color:#f9e2af>Redeemer</span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89dceb>validator</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>fn</span> <span style=color:#b4befe>mint_my_cool_token</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>_redeemer</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Redeemer</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>_ctx</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptContext</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>-&gt;</span> <span style=color:#f9e2af>Bool</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f9e2af>True</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>This validator ignores the redeemer completely. Because it always returns <code>True</code>, the associated tokens can be minted and burned freely! To mint some of our new token, we can build a transaction with Lucid like this:</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#585b70;font-style:italic>// ... setup lucid, select a wallet ...
</span></span></span><span style=display:flex><span><span style=color:#585b70;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>assetName</span> <span style=color:#89dceb>=</span> <span style=color:#a6e3a1>`</span><span style=color:#a6e3a1>${</span><span style=color:#b4befe>ourMintingPolicyId</span><span style=color:#a6e3a1>}${</span><span style=color:#b4befe>fromText</span><span style=color:#cdd6f4>(</span><span style=color:#a6e3a1>&#34;COOL&#34;</span><span style=color:#cdd6f4>)</span><span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>`</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>tx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>attachMintingPolicy</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>ourMintingPolicy</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>mintAssets</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#cdd6f4>[</span><span style=color:#b4befe>assetName</span><span style=color:#cdd6f4>]</span><span style=color:#89dceb>:</span> 10000000000<span style=color:#b4befe>n</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>},</span> 
</span></span><span style=display:flex><span>        <span style=color:#b4befe>Data</span><span style=color:#cdd6f4>.</span><span style=color:#cba6f7>void</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#585b70;font-style:italic>// ... sign &amp; submit transaction ... 
</span></span></span></code></pre></div><p>Submitting such a transaction would mint 10 billion tokens with the name &ldquo;COOL&rdquo; under the policy id that has been derived from our validator. Some notable elements are required here.</p><ol><li><strong>assetName</strong>: There can be many tokens with different names under a single policy. In order to uniquely identify a specific token with a specific policy, the policy id is concatenated with the hex encoded token name. In this case, we are minting tokens named &ldquo;COOL&rdquo;.</li><li><strong>attachMintingPolicy</strong>: Attaching the entire content of the minting policy script itself is required for every transaction that mints or burns tokens. Attempting to mint an asset that uses a policy id without an associated minting policy in the transaction will result in an error.</li><li><strong>mintAssets</strong>: The first argument to mint assets, straightforwardly, is a map of the asset name to be minted to the amount to mint of that asset. The second argument is the <em>redeemer</em>, which is the first parameter to the validator we defined above. Since our minting policy ignores the redeemer, we can send anything. But what if it didn&rsquo;t?</li></ol><p>Consider a contract that requires the user to know a code word to mint a token. This isn&rsquo;t very secure, since neither the content of your contract nor the redeemer itself is a secret. A guessed word is, however, a great example of the kind of data we couldn&rsquo;t easily access in a standalone minting policy without a redeemer.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#cba6f7>type</span> <span style=color:#f9e2af>CoolTokenRedeemer</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>guessed_word</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ByteArray</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89dceb>validator</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>fn</span> <span style=color:#b4befe>mint_my_cool_token</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>redeemer</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>CoolTokenRedeemer</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>_ctx</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptContext</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>-&gt;</span> <span style=color:#f9e2af>Bool</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>let</span> <span style=color:#b4befe>code_word</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#34;secret&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#b4befe>redeemer</span><span style=color:#89dceb>.</span><span style=color:#b4befe>guessed_word</span> <span style=color:#89dceb>==</span> <span style=color:#b4befe>code_word</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>By defining a type for the redeemer, we declare what the validator expects as input: a <code>guessed word</code> as a <code>ByteArray</code>. In Aiken, strings are just ByteArrays, so both the type and the validation are easy to implement here. If the redeemer includes a <code>guessed_word</code> of <code>"secret"</code>, the associated transaction may mint or burn whatever amount of tokens it requests.</p><p>Things get more exotic with Lucid and TypeScript. Here&rsquo;s an implementation of a transaction that mints from that contract.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>import</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>Data</span> <span style=color:#cdd6f4>}</span> <span style=color:#cba6f7>from</span> <span style=color:#a6e3a1>&#34;https://deno.land/x/lucid@0.10.7/mod.ts&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>CoolTokenRedeemerSchema</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>Data</span><span style=color:#cdd6f4>.</span><span style=font-style:italic>Object</span><span style=color:#cdd6f4>({</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>guessed_word</span>: <span style=color:#f9e2af>Data.Bytes</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>})</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>type</span> <span style=color:#b4befe>CoolTokenRedeemer</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>Data</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>Static</span><span style=color:#cdd6f4>&lt;</span><span style=color:#cba6f7>typeof</span> <span style=color:#f9e2af>CoolTokenRedeemer</span><span style=color:#cdd6f4>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>CoolTokenRedeemer</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>CoolTokenRedeemerSchema</span> <span style=color:#cba6f7>as</span> <span style=color:#f9e2af>unknown</span> <span style=color:#cba6f7>as</span> <span style=color:#b4befe>CoolTokenRedeemer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#585b70;font-style:italic>// ... setup lucid ...
</span></span></span><span style=display:flex><span><span style=color:#585b70;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>assetName</span> <span style=color:#89dceb>=</span> <span style=color:#a6e3a1>`</span><span style=color:#a6e3a1>${</span><span style=color:#b4befe>ourMintingPolicyId</span><span style=color:#a6e3a1>}${</span><span style=color:#b4befe>fromText</span><span style=color:#cdd6f4>(</span><span style=color:#a6e3a1>&#34;COOL&#34;</span><span style=color:#cdd6f4>)</span><span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>`</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>tx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>attachMintingPolicy</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>ourMintingPolicy</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>mintAssets</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#cdd6f4>[</span><span style=color:#b4befe>assetName</span><span style=color:#cdd6f4>]</span><span style=color:#89dceb>:</span> 10000000000<span style=color:#b4befe>n</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>},</span> 
</span></span><span style=display:flex><span>        <span style=color:#b4befe>Data</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>to</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>            <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>guessed_word</span><span style=color:#89dceb>:</span> <span style=color:#a6e3a1>&#34;secret&#34;</span> <span style=color:#cdd6f4>},</span> 
</span></span><span style=display:flex><span>            <span style=color:#b4befe>CoolTokenRedeemer</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#585b70;font-style:italic>// ... sign &amp; submit transaction ... 
</span></span></span></code></pre></div><p>An awful lot of extra code just to add a redeemer! There is some boilerplate for representing Aiken types with Lucid and TypeScript, but with good reason. Without using Lucid, types that you represent in Aiken would have to be encoded as order-sensitive JSON with nameless keys. Our instance of <code>CoolTokenRedeemer</code> is really just this under the hood:</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cba6f7>&#34;constructor&#34;</span><span style=color:#cdd6f4>:</span> 0<span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>	<span style=color:#cba6f7>&#34;fields&#34;</span><span style=color:#cdd6f4>:</span> <span style=color:#cdd6f4>[{</span>
</span></span><span style=display:flex><span>		<span style=color:#cba6f7>&#34;bytes&#34;</span><span style=color:#cdd6f4>:</span> 736563726574
</span></span><span style=display:flex><span>	<span style=color:#cdd6f4>}]</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>Lucid provides the <code>Data</code> schema builder to simplify the construction of such JSON structures. Notably, the TypeScript types enforce certain data transformations, like accepting strings for byte fields. We will explore <code>Data</code> further, but I recommend keeping the <a href=https://github.com/spacebudz/lucid/blob/main/tests/data.test.ts>Data tests in Lucid</a> open as a reference when first working with it.</p><p>As we&rsquo;ve demonstrated, the redeemer gives the caller the ability to react to the state of the contract. Indeed, the only way to make a useful minting policy redeemer at all is by making the contract stateful. In this case, the state is the code word, <code>"secret"</code>. Hardcoding our state, however, does not result in a flexible contract. How do we have dynamic state in our contract?</p><p>One way you might try to achieve this dynamism is by parameterizing the validator itself.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#cba6f7>type</span> <span style=color:#f9e2af>CoolTokenRedeemer</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>guessed_word</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ByteArray</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89dceb>validator</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>code_word</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ByteArray</span><span style=color:#cdd6f4>)</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>fn</span> <span style=color:#b4befe>mint_my_cool_token</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>redeemer</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>CoolTokenRedeemer</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>_ctx</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptContext</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>-&gt;</span> <span style=color:#f9e2af>Bool</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#b4befe>redeemer</span><span style=color:#89dceb>.</span><span style=color:#b4befe>guessed_word</span> <span style=color:#89dceb>==</span> <span style=color:#b4befe>code_word</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>In this way, the hardcoded secret can be removed. Running <code>aiken build</code> generates <code>plutus.json</code> with our script in it, and we can parameterize that script like this:</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>import</span> <span style=color:#b4befe>blueprint</span> <span style=color:#cba6f7>from</span> <span style=color:#a6e3a1>&#34;../plutus.json&#34;</span> <span style=color:#b4befe>assert</span> <span style=color:#cdd6f4>{</span> <span style=color:#cba6f7>type</span><span style=color:#89dceb>:</span> <span style=color:#a6e3a1>&#34;json&#34;</span> <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>import</span> <span style=color:#cdd6f4>{</span> 
</span></span><span style=display:flex><span>  <span style=color:#b4befe>applyDoubleCborEncoding</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>  <span style=color:#b4befe>applyParamsToScript</span> 
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span> <span style=color:#cba6f7>from</span> <span style=color:#a6e3a1>&#34;https://deno.land/x/lucid@0.10.7/mod.ts&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>mintCoolToken</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>blueprint</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>validators</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>find</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>v</span> <span style=color:#89dceb>=&gt;</span> <span style=color:#b4befe>v</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>title</span> <span style=color:#89dceb>===</span> <span style=color:#a6e3a1>&#34;cool.mint_my_cool_token&#34;</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>)</span><span style=color:#89dceb>!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>parameterizedMintCoolToken</span> <span style=color:#89dceb>=</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>type</span><span style=color:#89dceb>:</span> <span style=color:#a6e3a1>&#34;PlutusV2&#34;</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>script</span>: <span style=color:#f9e2af>applyDoubleCborEncoding</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>applyParamsToScript</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>guessMintingPolicy</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>script</span><span style=color:#cdd6f4>,</span> <span style=color:#cdd6f4>[</span><span style=color:#b4befe>fromText</span><span style=color:#cdd6f4>(</span><span style=color:#a6e3a1>&#34;new secret&#34;</span><span style=color:#cdd6f4>)]</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>tx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>attachMintingPolicy</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>parameterizedMintCoolToken</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>mintAssets</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#cdd6f4>[</span><span style=color:#b4befe>assetName</span><span style=color:#cdd6f4>]</span><span style=color:#89dceb>:</span> 10000000000<span style=color:#b4befe>n</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>},</span> 
</span></span><span style=display:flex><span>        <span style=color:#b4befe>Data</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>to</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>            <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>guessed_word</span>: <span style=color:#f9e2af>fromText</span><span style=color:#cdd6f4>(</span><span style=color:#a6e3a1>&#34;new secret&#34;</span><span style=color:#cdd6f4>)</span> <span style=color:#cdd6f4>},</span> 
</span></span><span style=display:flex><span>            <span style=color:#b4befe>CoolTokenRedeemer</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span></code></pre></div><p>This is interesting, because now we can create new contracts in our client applications at runtime. Users could each provide a custom code word and receive a custom minting policy that only works with the word they&rsquo;ve chosen. But this has a potentially fatal flaw: the tokens minted by each user will have a unique policy id. They <em>aren&rsquo;t the same token</em>. In certain cases, like creating a gift card, that can be desirable - a policy mints a single gift card for a single payment by a single user. In our case, all this means is we aren&rsquo;t any closer to having dynamic state! We&rsquo;re exactly where we were before. Each unique minting policy has a single, hardcoded code word; we just have many policies now.</p><p>So, really, how do we store state on-chain?</p><h2 id=spending-validators--datums>Spending Validators & Datums</h2><p>Suppose we want to create a minting policy that only allows a certain number of tokens to be in circulation. Say, at most, 1,000,000 tokens. Once that minting cap has been reached, they can be burned, at which point it should be possible to mint more. How can the minting policy know how many tokens are in circulation? This information is easy to get off-chain through <a href=https://blockfrost.io/>Blockfrost</a> or <a href=https://github.com/input-output-hk/cardano-db-sync/tree/master>cardano-db-sync</a>, but the minting policy alone has no mechanism to prove that a submitted value from these sources has not been manipulated. Mechanically, we could accept it as a redeemer value, but there&rsquo;s no sense; the user submitting the transaction could provide <em>any</em> value, and there&rsquo;s no ground truth to check the submission against.</p><p>To do this, we need <em>validated</em> and <em>dynamic</em> state that can be accessed in a contract and is resilient to malicious updates. Spending validators, our second kind of contract, have this luxury via the <em>datum</em>.</p><p>A datum is optional, arbitrary data that is stored alongside a utxo. When sending assets to an address, a transaction author can include in each output whatever datum and whatever assets they like. There is no such thing as a &ldquo;receive&rdquo; validator. Our spend validator will, as the name suggests, only execute when a utxo is <em>spent</em> from the contract address.</p><p>Since a single address can have many utxos, it can also contain many datums. As such, there is not naturally a single datum that contains the global state of the contract address. Every unspent output at the address is independently subject to the terms of spending that are enforced by the spending validator.</p><p>Here&rsquo;s a variant of the Hello World example from the Aiken tutorial. This spending validator accepts arbitrarily-valued utxos that contain a datum with an <code>owner</code>&rsquo;s verification key, and only allows those utxos to be spent in transactions signed by that same owner.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#89dceb>use</span> <span style=color:#b4befe>aiken</span><span style=color:#89dceb>/</span><span style=color:#b4befe>transaction</span><span style=color:#89dceb>.</span><span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f9e2af>InlineDatum</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#f9e2af>ScriptContext</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#f9e2af>Redeemer</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#f9e2af>Spend</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>find_input</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span><span style=color:#89dceb>use</span> <span style=color:#b4befe>aiken</span><span style=color:#89dceb>/</span><span style=color:#b4befe>list</span>
</span></span><span style=display:flex><span><span style=color:#89dceb>use</span> <span style=color:#b4befe>aiken</span><span style=color:#89dceb>/</span><span style=color:#b4befe>hash</span><span style=color:#89dceb>.</span><span style=color:#cdd6f4>{</span><span style=color:#f9e2af>Blake2b_224</span><span style=color:#cdd6f4>,</span> <span style=color:#f9e2af>Hash</span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span><span style=color:#89dceb>use</span> <span style=color:#b4befe>aiken</span><span style=color:#89dceb>/</span><span style=color:#b4befe>transaction</span><span style=color:#89dceb>/</span><span style=color:#b4befe>credential</span><span style=color:#89dceb>.</span><span style=color:#cdd6f4>{</span><span style=color:#f9e2af>VerificationKey</span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>type</span> <span style=color:#f9e2af>VerificationKeyHash</span> <span style=color:#89dceb;font-weight:700>=</span>
</span></span><span style=display:flex><span>  <span style=color:#f9e2af>Hash</span><span style=color:#89dceb>&lt;</span><span style=color:#f9e2af>Blake2b_224</span><span style=color:#cdd6f4>,</span> <span style=color:#f9e2af>VerificationKey</span><span style=color:#89dceb>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>type</span> <span style=color:#f9e2af>OwnerDatum</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>owner</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>VerificationKeyHash</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89dceb>validator</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>fn</span> <span style=color:#b4befe>only_for_owner</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>_datum</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Data</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>      <span style=color:#b4befe>_redeemer</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Redeemer</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>ctx</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptContext</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>-&gt;</span> <span style=color:#f9e2af>Bool</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>let</span> <span style=color:#f9e2af>ScriptContext</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>transaction</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>purpose</span> <span style=color:#cdd6f4>}</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>ctx</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>Spend</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>spent_utxo_reference</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>purpose</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>Some</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>input</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>find_input</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#b4befe>transaction</span><span style=color:#89dceb>.</span><span style=color:#b4befe>inputs</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>        <span style=color:#b4befe>spent_utxo_reference</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>InlineDatum</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>maybe_owner_datum</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>input</span><span style=color:#89dceb>.</span><span style=color:#b4befe>output</span><span style=color:#89dceb>.</span><span style=color:#b4befe>datum</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#b4befe>owner_datum</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>OwnerDatum</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>maybe_owner_datum</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>has</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>transaction</span><span style=color:#89dceb>.</span><span style=color:#b4befe>extra_signatories</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>owner_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>owner</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>Destructuring the <code>ScriptContext</code> gives us access to a <code>Transaction</code>. The Aiken docs have <a href=https://aiken-lang.github.io/stdlib/aiken/transaction.html#Transaction>a complete description of the fields available within the transaction</a>, but, in this case, we are interested in the <code>inputs</code> and the <code>extra_signatories</code>. This validator searches the transaction <code>inputs</code> to find the utxo that is being spent from the contract address. It expects an inline <code>OwnerDatum</code> to exist on that utxo. Finally, it checks that the transaction was signed by the owner defined in the datum.</p><p>Let&rsquo;s lock funds into the contract.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>import</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>Data</span> <span style=color:#cdd6f4>}</span> <span style=color:#cba6f7>from</span> <span style=color:#a6e3a1>&#34;https://deno.land/x/lucid@0.10.7/mod.ts&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#585b70;font-style:italic>// ... setup Lucid, select a wallet ...
</span></span></span><span style=display:flex><span><span style=color:#585b70;font-style:italic></span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>owner</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>utils</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>getAddressDetails</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>recipientAddress</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>).</span><span style=color:#b4befe>paymentCredential</span><span style=color:#89dceb>!</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>hash</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>datum</span>: <span style=color:#f9e2af>OwnerDatum</span> <span style=color:#89dceb>=</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>owner</span> <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>tx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>.</span><span style=color:#b4befe>payToAddressWithData</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>inline</span>: <span style=color:#f9e2af>Data.to</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>datum</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>OwnerDatum</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>},</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>lovelace</span>: <span style=color:#f9e2af>50000000n</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span></code></pre></div><p>This is just a call to <strong>payToAddressWithData</strong>. Our transaction has a single operation: a payment of 50 ADA to the contract address. It&rsquo;s important that this transaction includes a <em>valid</em> datum. The contract will not execute until the utxo is <em>spent</em>, so the contents of this send are completely unvalidated. It will always succeed, even if the datum is erroneous! For simplicity, we are having the same wallet both store and retrieve the ADA, but this deposit could have come from anyone, and they could have set any owner in the datum.</p><p>Also notice that this is an <em>inline</em> datum. This means that the full content of the datum is stored on-chain, rather than just the hash. We will be using inline datums for convenience, but keep in mind that they do increase transaction size as the amount of data they store increases. <a href=https://cips.cardano.org/cips/cip32/>More reading here.</a></p><p>Now we must spend the 50 ADA we put into the contract. To do so, search the utxos at the contract address for the deposit that was just made, then specify that utxo as an input to the transaction with <code>collectFrom</code>. Because this is a spend from a script address, a redeemer <em>must</em> be provided to <code>collectFrom</code>. Failure to do so will result in a confusing <code>Error: Missing script witness</code>. The value of the redeemer is irrelevant in our validator, so we can pass <code>Data.void()</code> as an empty redeemer input.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>contractUtxos</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>utxosAt</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>depositUtxo</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>contractUtxos</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>find</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>txo</span> <span style=color:#89dceb>=&gt;</span> <span style=color:#b4befe>txo</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>txHash</span> <span style=color:#89dceb>===</span> <span style=color:#b4befe>depositTxHash</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>)</span><span style=color:#89dceb>!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>withdrawlTx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>collectFrom</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>[</span><span style=color:#b4befe>depositUtxo</span><span style=color:#cdd6f4>],</span>
</span></span><span style=display:flex><span>        <span style=color:#b4befe>Data</span><span style=color:#cdd6f4>.</span><span style=color:#cba6f7>void</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>attachSpendingValidator</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>ownerValidator</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>addSigner</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>recipientAddress</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>withdrawlSigned</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>withdrawlTx</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>sign</span><span style=color:#cdd6f4>().</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>withdrawlTxHash</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>withdrawlSigned</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>submit</span><span style=color:#cdd6f4>()</span>
</span></span></code></pre></div><p>Like with the minting policy, the entire spending validator needs to be included within the transaction via <code>attachSpendingValidator</code>. Additionally, the signatory requirement must be explicitly specified in the transaction via <code>addSigner</code>. Unlike a normal spend from a wallet address, the contract&rsquo;s reliance on the <code>owner</code> signature can not be inferred by Lucid.</p><p>So the funds have been successfully retrieved from the contract. This means that the utxo containing our <code>OwnerDatum</code> has been spent, and that data is no longer accessible from within a contract. It could be retrieved off-chain, but only unspent outputs can be inputs to transactions. How, then, can there be persisted on-chain state without making the utxo unspendable?</p><p>Let&rsquo;s implement a counting contract to demonstrate. The contract will enforce that for every spend from the counting address, there is a new output back to the address that increments the count.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#89dceb>validator</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>type</span> <span style=color:#f9e2af>CountDatum</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>owner</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>VerificationKeyHash</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>count</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Int</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>fn</span> <span style=color:#b4befe>count</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>_datum</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Data</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>      <span style=color:#b4befe>_redeemer</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Redeemer</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>ctx</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptContext</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>-&gt;</span> <span style=color:#f9e2af>Bool</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>let</span> <span style=color:#f9e2af>ScriptContext</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>transaction</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>purpose</span> <span style=color:#cdd6f4>}</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>ctx</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>Spend</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>spent_utxo_reference</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>purpose</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>Some</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>input</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>find_input</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#b4befe>transaction</span><span style=color:#89dceb>.</span><span style=color:#b4befe>inputs</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>        <span style=color:#b4befe>spent_utxo_reference</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>InlineDatum</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>maybe_old_count_datum</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>input</span><span style=color:#89dceb>.</span><span style=color:#b4befe>output</span><span style=color:#89dceb>.</span><span style=color:#b4befe>datum</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#b4befe>old_count_datum</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>CountDatum</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>maybe_old_count_datum</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>let</span> <span style=color:#b4befe>count_script_address</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>input</span><span style=color:#89dceb>.</span><span style=color:#b4befe>output</span><span style=color:#89dceb>.</span><span style=color:#b4befe>address</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>Some</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>output</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>transaction</span><span style=color:#89dceb>.</span><span style=color:#b4befe>outputs</span>
</span></span><span style=display:flex><span>      <span style=color:#89dceb>|&gt;</span> <span style=color:#b4befe>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>filter</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>fn</span> <span style=color:#cdd6f4>(</span><span style=color:#b4befe>output</span><span style=color:#cdd6f4>)</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#b4befe>output</span><span style=color:#89dceb>.</span><span style=color:#b4befe>address</span> <span style=color:#89dceb>==</span> <span style=color:#b4befe>count_script_address</span>
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>})</span>
</span></span><span style=display:flex><span>      <span style=color:#89dceb>|&gt;</span> <span style=color:#b4befe>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>head</span><span style=font-style:italic>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>InlineDatum</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>maybe_new_count_datum</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>output</span><span style=color:#89dceb>.</span><span style=color:#b4befe>datum</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#b4befe>new_count_datum</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>CountDatum</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>maybe_new_count_datum</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#b4befe>and</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>has</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>transaction</span><span style=color:#89dceb>.</span><span style=color:#b4befe>extra_signatories</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>old_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>owner</span><span style=color:#cdd6f4>),</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>new_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>count</span> <span style=color:#89dceb>==</span> <span style=color:#b4befe>old_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>count</span> <span style=color:#89dceb>+</span> 1<span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>new_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>owner</span> <span style=color:#89dceb>==</span> <span style=color:#b4befe>old_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>owner</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>This is much like the previous spending validator; we&rsquo;ve just added an additional requirement via the <code>count</code> field of the datum. In addition to having permission to spend the utxo at the count script address, the caller must include an output back to the same address that includes an appropriately incremented datum. For simplicity&rsquo;s sake, the contract assumes that there is only a single script output (a single updated count), but it could have been written to support multiple at once.</p><p>Composing the initial transaction is no different than before. Just update the datum type.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>owner</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>utils</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>getAddressDetails</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>recipientAddress</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>).</span><span style=color:#b4befe>paymentCredential</span><span style=color:#89dceb>!</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>hash</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>count</span> <span style=color:#89dceb>=</span> 0<span style=color:#b4befe>n</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>originalDatum</span>: <span style=color:#f9e2af>CountDatum</span> <span style=color:#89dceb>=</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>owner</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>count</span> <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>depositTx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>.</span><span style=color:#b4befe>payToAddressWithData</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>inline</span>: <span style=color:#f9e2af>Data.to</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>originalDatum</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>CountDatum</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>},</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>{}</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span></code></pre></div><p>Since the asset value being stored here is irrelevant, it can be omitted. Lucid will automatically calculate the minimum amount of ADA required and add it to the transaction outputs from the currently configured wallet. Spending is similar, but not identical, to the last spending validator. This time the contract mandates a spend <em>back</em> to the contract with the updated datum. So in addition to <code>collectFrom</code> to initialize the spend, we must include an appropriately parameterized <code>payToAddressWithData</code> back to the contract.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>contractUtxos</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>utxosAt</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>depositUtxo</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>contractUtxos</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>find</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>txo</span> <span style=color:#89dceb>=&gt;</span> <span style=color:#b4befe>txo</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>txHash</span> <span style=color:#89dceb>===</span> <span style=color:#b4befe>depositTxHash</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>)</span><span style=color:#89dceb>!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>updatedDatum</span>: <span style=color:#f9e2af>CountDatum</span> <span style=color:#89dceb>=</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>owner</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>count</span>: <span style=color:#f9e2af>count</span> <span style=color:#89dceb>+</span> 1<span style=color:#b4befe>n</span> <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>withdrawlTx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>collectFrom</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>[</span><span style=color:#b4befe>depositUtxo</span><span style=color:#cdd6f4>],</span>
</span></span><span style=display:flex><span>        <span style=color:#b4befe>Data</span><span style=color:#cdd6f4>.</span><span style=color:#cba6f7>void</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>attachSpendingValidator</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>countValidator</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>payToAddressWithData</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>inline</span>: <span style=color:#f9e2af>Data.to</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>updatedDatum</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>CountDatum</span><span style=color:#cdd6f4>)},</span> 
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>addSigner</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>recipientAddress</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span></code></pre></div><p>Success! Let&rsquo;s check the result.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>countUtxos</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>utxosAt</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span><span style=color:#b4befe>console</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>log</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>JSON</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>stringify</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>countUtxos</span><span style=color:#cdd6f4>,</span> <span style=color:#cba6f7;font-style:italic>null</span><span style=color:#cdd6f4>,</span> 2<span style=color:#cdd6f4>))</span>
</span></span></code></pre></div><p>That gives us a datum <code>d8799f581cac8f9db1a45ce3ed263aac3fa022e82705d190e3e31dd963ee295a4701ff</code>. Plugging that into the <a href="https://cardanoscan.io/datumInspector?datum=d8799f581cac8f9db1a45ce3ed263aac3fa022e82705d190e3e31dd963ee295a4701ff">datum decoder</a> gives us the expected data. <code>count</code>, the second field, has been incremented by 1.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>   <span style=color:#b4befe>constructor</span><span style=color:#89dceb>:</span> 0<span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>   <span style=color:#b4befe>fields</span><span style=color:#89dceb>:</span> <span style=color:#cdd6f4>[</span>
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>         <span style=color:#b4befe>bytes</span><span style=color:#89dceb>:</span> <span style=color:#a6e3a1>&#34;ac8f9db1a45ce3ed263aac3fa022e82705d190e3e31dd963ee295a47&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>},</span>
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>         <span style=color:#cba6f7>int</span><span style=color:#89dceb>:</span> 1
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>   <span style=color:#cdd6f4>]</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>To ensure the validator is working properly, we can try updating the datum incorrectly, like so:</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>updatedDatum</span>: <span style=color:#f9e2af>CountDatum</span> <span style=color:#89dceb>=</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>owner</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>count</span>: <span style=color:#f9e2af>count</span> <span style=color:#89dceb>+</span> 2<span style=color:#b4befe>n</span> <span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>That results in an expected failure.</p><pre tabindex=0><code>Uncaught (in promise) &#34;Redeemer (Spend, 0): 
The provided Plutus code called &#39;error&#39;
</code></pre><p>Now we have validated, persistent on-chain state that we can consume in a contract! That&rsquo;s exciting, but&mldr;</p><h2 id=all-together-now>All Together Now</h2><p>Unfortunately, there is a glaring vulnerability in our approach. What if the first transaction sent to the count script address looked like this?</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>count</span> <span style=color:#89dceb>=</span> 9999999<span style=color:#b4befe>n</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>datum</span>: <span style=color:#f9e2af>CountDatum</span> <span style=color:#89dceb>=</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>owner</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>count</span> <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>depositTx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>.</span><span style=color:#b4befe>payToAddressWithData</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>inline</span>: <span style=color:#f9e2af>Data.to</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>datum</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>CountDatum</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>},</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>{}</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span></code></pre></div><p>Since this initial send to the contract address does not trigger the spending validator, we can make no guarantees about its authenticity! A caller can easily spoof arbitrarily high counts. If we are trying to build a trustless protocol from our contracts, this is a problem. How do you validate a &ldquo;new&rdquo; output to the contract address?</p><p>One interesting property of minting policies is that they produce utxos without consuming any inputs. This means that if we can prove a utxo was created with the permission of a particular minting policy, we can know - in a guaranteed and trustless way - that the initial state of the datum on that utxo is valid. This &ldquo;proof&rdquo; can be provided in the form of an NFT minted and placed on the utxo. The minting policy will validate that the NFTs are only ever created at our count script address, and the count contract will verify that the NFTs are never spent to an address other than the contract&rsquo;s own. In this way, we can be confident that any transaction output that contains this &ldquo;authorizing&rdquo; NFT was formed per the rules of our contract.</p><p>Let&rsquo;s break that down and implement it. Remember to check the full code for the <a href=https://github.com/Piefayth/aiken-blog-1-code/blob/main/validators/secure_count.ak>script</a> and <a href=https://github.com/Piefayth/aiken-blog-1-code/blob/main/scripts/secure_count.ts>validator</a> as needed. There are three core logical checks that the minting policy must do.</p><ol><li>Check that this transaction does not spend an existing count datum. This isn&rsquo;t a technical restriction; it is possible to both update an existing count datum in the same transaction that new one is created. This is merely a simplification we are performing to reduce the complexity of the contract.</li><li>Check that each newly created utxo contains a properly formed datum.</li><li>Make sure only one NFT is minted per new count datum. If it were possible to mint extra NFTs, they could, in future transactions, be sent to arbitrary addresses without being checked by the minting policy. This would allow for forged datums by spending an NFT into the count contract without applying the minting policy!</li></ol><p>Here&rsquo;s an outline of our validator.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#cba6f7>type</span> <span style=color:#f9e2af>CountDatum</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>owner</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>VerificationKeyHash</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>authorizing_policy</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptHash</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>count</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Int</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89dceb>validator</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>count_script_hash</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ByteArray</span><span style=color:#cdd6f4>)</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>fn</span> <span style=color:#b4befe>count_authorizer</span><span style=color:#cdd6f4>(</span>      
</span></span><span style=display:flex><span>      <span style=color:#b4befe>_redeemer</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Redeemer</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>ctx</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptContext</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>)</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>let</span> <span style=color:#f9e2af>ScriptContext</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>transaction</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>purpose</span> <span style=color:#cdd6f4>}</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>ctx</span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>let</span> <span style=color:#f9e2af>Transaction</span> <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>inputs</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>outputs</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>mint</span><span style=color:#cdd6f4>,</span> <span style=color:#89dceb>..</span> <span style=color:#cdd6f4>}</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>transaction</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>Mint</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>policy_id</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>purpose</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>let</span> <span style=color:#b4befe>authorizing_token_name</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#34;COUNT&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#b4befe>no_count_data_in_inputs</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>inputs</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>count_script_hash</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>let</span> <span style=color:#b4befe>new_count_outputs</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>find_script_outputs</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>outputs</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>count_script_hash</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#b4befe>no_invalid_count_data</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>transaction</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>new_count_outputs</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>      <span style=color:#b4befe>authorizing_token_name</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>      <span style=color:#b4befe>policy_id</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>let</span> <span style=color:#b4befe>num_minted</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>mint</span> 
</span></span><span style=display:flex><span>        <span style=color:#89dceb>|&gt;</span> <span style=color:#b4befe>value</span><span style=color:#89dceb>.</span><span style=color:#b4befe>from_minted_value</span>
</span></span><span style=display:flex><span>        <span style=color:#89dceb>|&gt;</span> <span style=color:#b4befe>quantity_of</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>policy_id</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>authorizing_token_name</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>length</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>new_count_outputs</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb>==</span> <span style=color:#b4befe>num_minted</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>}</span> 
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>There is a new field in our datum: <code>authorizing_policy</code>. Because this minting policy is parameterized by the <code>count_script_hash</code>, we can not, in turn, parameterize the count script itself with the minting policy id. Doing so would create a circular dependency. To handle that, the <code>policy_id</code> is assigned to a field of the datum and validated in the minting transaction. That <code>policy_id</code> can then be consumed in the spending validator.</p><p>Checks #1 and #2 have been factored into the functions <code>no_count_data_in_inputs</code> and <code>no_invalid_count_data</code> respectively. For the former, we can leverage the built-in <code>find_script_outputs</code>. Given a list of outputs, this function will return only outputs that are to a particular script. If that list is empty, we can be sure that this transaction does not include any spends from the count script address.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#89dceb>fn</span> <span style=color:#b4befe>no_count_data_in_inputs</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>inputs</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>List</span><span style=color:#89dceb>&lt;</span><span style=color:#f9e2af>Input</span><span style=color:#89dceb>&gt;</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>  <span style=color:#b4befe>count_script_hash</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptHash</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>-&gt;</span> <span style=color:#f9e2af>Bool</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>map</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>inputs</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>fn</span> <span style=color:#cdd6f4>(</span><span style=color:#b4befe>input</span><span style=color:#cdd6f4>){</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>input</span><span style=color:#89dceb>.</span><span style=color:#b4befe>output</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>})</span>
</span></span><span style=display:flex><span>  <span style=color:#89dceb>|&gt;</span> <span style=color:#b4befe>find_script_outputs</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>count_script_hash</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>  <span style=color:#89dceb>|&gt;</span> <span style=color:#b4befe>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>is_empty</span><span style=font-style:italic>()</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>Afterwards, the outputs to the count script address must be verified with <code>no_invalid_count_data</code>. There are several conditions to check.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#89dceb>fn</span> <span style=color:#b4befe>no_invalid_count_data</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>transaction</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Transaction</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>script_outputs</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>List</span><span style=color:#89dceb>&lt;</span><span style=color:#f9e2af>Output</span><span style=color:#89dceb>&gt;</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>  <span style=color:#b4befe>authorizing_token_name</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ByteArray</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>policy_id</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptHash</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>-&gt;</span> <span style=color:#f9e2af>Bool</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>all</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>script_outputs</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>fn</span> <span style=color:#cdd6f4>(</span><span style=color:#b4befe>output</span><span style=color:#cdd6f4>)</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#f9e2af>InlineDatum</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>maybe_new_count_datum</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>output</span><span style=color:#89dceb>.</span><span style=color:#b4befe>datum</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#b4befe>new_count_datum</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>CountDatum</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>maybe_new_count_datum</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>let</span> <span style=color:#b4befe>has_exactly_one_authorizing_nft</span> <span style=color:#89dceb;font-weight:700>=</span> 
</span></span><span style=display:flex><span>      1 <span style=color:#89dceb>==</span> <span style=color:#b4befe>quantity_of</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>output</span><span style=color:#89dceb>.</span><span style=color:#b4befe>value</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>policy_id</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>authorizing_token_name</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>and</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>has</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>transaction</span><span style=color:#89dceb>.</span><span style=color:#b4befe>extra_signatories</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>new_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>owner</span><span style=color:#cdd6f4>),</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>has_exactly_one_authorizing_nft</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>new_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>count</span> <span style=color:#89dceb>==</span> 0<span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>new_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>authorizing_policy</span> <span style=color:#89dceb>==</span> <span style=color:#b4befe>policy_id</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>})</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>This checks that</p><ol><li>The datum is the right shape</li><li>There is one and only one NFT from this minting policy in each output</li><li>Each output is signed by its owner</li><li>The datum has appropriate values for a new count datum (i.e. 0)</li></ol><p>Our final check validates that no extra NFTs from this policy were minted. Our previous checks guarantee that there is no more than one NFT per output, and no pre-existing NFTs in the input, so checking that the amount minted is equal to the number of script outputs is sufficient here.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#cba6f7>let</span> <span style=color:#b4befe>num_minted</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#b4befe>mint</span> 
</span></span><span style=display:flex><span>    <span style=color:#89dceb>|&gt;</span> <span style=color:#b4befe>value</span><span style=color:#89dceb>.</span><span style=color:#b4befe>from_minted_value</span>
</span></span><span style=display:flex><span>    <span style=color:#89dceb>|&gt;</span> <span style=color:#b4befe>quantity_of</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>policy_id</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>authorizing_token_name</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#89dceb>list</span><span style=color:#89dceb>.</span><span style=color:#b4befe>length</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>new_count_outputs</span><span style=color:#cdd6f4>)</span> <span style=color:#89dceb>==</span> <span style=color:#b4befe>num_minted</span>
</span></span></code></pre></div><p>With the minting policy defined, it is possible to create a utxo at the count contract address with our validated initial datum. Note that in addition to minting the authorizing NFT, the NFT must be explicitly paid to the contract address.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>countMintingPolicyId</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>utils</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>validatorToScriptHash</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>parameterizedCountMintingPolicy</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>contractAddress</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>utils</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>validatorToAddress</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>secureCountValidator</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>count</span> <span style=color:#89dceb>=</span> 0<span style=color:#b4befe>n</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>originalDatum</span>: <span style=color:#f9e2af>CountDatum</span> <span style=color:#89dceb>=</span> <span style=color:#cdd6f4>{</span> 
</span></span><span style=display:flex><span>    <span style=color:#b4befe>owner</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#b4befe>count</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#b4befe>authorizing_policy</span>: <span style=color:#f9e2af>countMintingPolicyId</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>authorizingNFTName</span> <span style=color:#89dceb>=</span> <span style=color:#a6e3a1>`</span><span style=color:#a6e3a1>${</span><span style=color:#b4befe>countMintingPolicyId</span><span style=color:#a6e3a1>}${</span><span style=color:#b4befe>fromText</span><span style=color:#cdd6f4>(</span><span style=color:#a6e3a1>&#34;COUNT&#34;</span><span style=color:#cdd6f4>)</span><span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>initializingTx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>attachMintingPolicy</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>parameterizedCountMintingPolicy</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>mintAssets</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#cdd6f4>[</span><span style=color:#b4befe>authorizingNFTName</span><span style=color:#cdd6f4>]</span><span style=color:#89dceb>:</span> 1<span style=color:#b4befe>n</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>},</span> 
</span></span><span style=display:flex><span>        <span style=color:#b4befe>Data</span><span style=color:#cdd6f4>.</span><span style=color:#cba6f7>void</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>payToAddressWithData</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#b4befe>inline</span>: <span style=color:#f9e2af>Data.to</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>originalDatum</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>CountDatum</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>},</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#cdd6f4>[</span><span style=color:#b4befe>authorizingNFTName</span><span style=color:#cdd6f4>]</span><span style=color:#89dceb>:</span> 1<span style=color:#b4befe>n</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>addSigner</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>recipientAddress</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span></code></pre></div><p>Now the state of our initial datum for the counting validator is guaranteed by the minting policy. Back in the count spending validator, two additional checks are required.</p><ol><li>The input being spent from the count script address holds an authorizing NFT.</li><li>The output being created with the updated count also holds the authorizing NFT.</li></ol><p>Both checks are effectively the same logic.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#89dceb>fn</span> <span style=color:#b4befe>output_has_authorizing_nft</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>output</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Output</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>  <span style=color:#b4befe>authorizing_policy</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptHash</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span><span style=color:#cdd6f4>)</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>let</span> <span style=color:#b4befe>authorizing_token_name</span> <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#34;COUNT&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  1 <span style=color:#89dceb>==</span> <span style=color:#b4befe>quantity_of</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>output</span><span style=color:#89dceb>.</span><span style=color:#b4befe>value</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#b4befe>authorizing_policy</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#b4befe>authorizing_token_name</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>Using this, we can add a few new assertions to the <code>count</code> spending validator&mldr;</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#89dceb>validator</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>  <span style=color:#b4befe>fn</span> <span style=color:#b4befe>count</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>_datum</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Data</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>      <span style=color:#b4befe>_redeemer</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>Redeemer</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>ctx</span><span style=color:#f9e2af>:</span> <span style=color:#f9e2af>ScriptContext</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>)</span> <span style=color:#89dceb;font-weight:700>-&gt;</span> <span style=color:#f9e2af>Bool</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#585b70;font-style:italic>-- ... snip ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#b4befe>output_has_authorizing_nft</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>input</span><span style=color:#89dceb>.</span><span style=color:#b4befe>output</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>      <span style=color:#b4befe>old_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>authorizing_policy</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#585b70;font-style:italic>-- ... snip ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>expect</span> <span style=color:#b4befe>output_has_authorizing_nft</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>output</span><span style=color:#cdd6f4>,</span> 
</span></span><span style=display:flex><span>      <span style=color:#b4befe>old_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>authorizing_policy</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>and</span> <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#585b70;font-style:italic>-- ... snip ...</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>new_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>authorizing_policy</span> <span style=color:#89dceb>==</span> <span style=color:#b4befe>old_count_datum</span><span style=color:#89dceb>.</span><span style=color:#b4befe>authorizing_policy</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>  <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span></code></pre></div><p>With the minting policy for the authorizing NFT in place, and the spending validator updated, we can now have a stateful count datum that is guaranteed to play by the rules we&rsquo;ve defined! Let&rsquo;s perform an update on our new count validator to make sure.</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>contractUtxos</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>utxosAt</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>countUtxo</span> <span style=color:#89dceb>=</span> <span style=color:#b4befe>contractUtxos</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>find</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>txo</span> <span style=color:#89dceb>=&gt;</span> <span style=color:#b4befe>txo</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>txHash</span> <span style=color:#89dceb>===</span> <span style=color:#b4befe>initializingTxHash</span><span style=color:#cdd6f4>)</span><span style=color:#89dceb>!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>updatedDatum</span>: <span style=color:#f9e2af>CountDatum</span> <span style=color:#89dceb>=</span> <span style=color:#cdd6f4>{</span> 
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>...</span><span style=color:#b4befe>originalDatum</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#b4befe>count</span>: <span style=color:#f9e2af>originalDatum.count</span> <span style=color:#89dceb>+</span> 1<span style=color:#b4befe>n</span>
</span></span><span style=display:flex><span><span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>updateCountTx</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>newTx</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>collectFrom</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>[</span><span style=color:#b4befe>countUtxo</span><span style=color:#cdd6f4>],</span>
</span></span><span style=display:flex><span>        <span style=color:#b4befe>Data</span><span style=color:#cdd6f4>.</span><span style=color:#cba6f7>void</span><span style=color:#cdd6f4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>attachSpendingValidator</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>secureCountValidator</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>payToAddressWithData</span><span style=color:#cdd6f4>(</span>
</span></span><span style=display:flex><span>      <span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>,</span>
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>{</span> <span style=color:#b4befe>inline</span>: <span style=color:#f9e2af>Data.to</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>updatedDatum</span><span style=color:#cdd6f4>,</span> <span style=color:#b4befe>CountDatum</span><span style=color:#cdd6f4>)},</span> 
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cdd6f4>[</span><span style=color:#b4befe>authorizingNFTName</span><span style=color:#cdd6f4>]</span><span style=color:#89dceb>:</span> 1<span style=color:#b4befe>n</span>
</span></span><span style=display:flex><span>      <span style=color:#cdd6f4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>addSigner</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>recipientAddress</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cdd6f4>.</span><span style=color:#b4befe>complete</span><span style=color:#cdd6f4>()</span>
</span></span></code></pre></div><p>There&rsquo;s nothing in this transaction that we haven&rsquo;t done before by now. Most importantly, the outputs include the forwarding of the original authorizing NFT.</p><p>At last, the result can be verified:</p><div class=highlight><pre tabindex=0 style=color:#fab387;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#cba6f7>const</span> <span style=color:#b4befe>countUtxos</span> <span style=color:#89dceb>=</span> <span style=color:#cba6f7>await</span> <span style=color:#b4befe>lucid</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>utxosAt</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>contractAddress</span><span style=color:#cdd6f4>)</span>
</span></span><span style=display:flex><span><span style=color:#b4befe>console</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>log</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>JSON</span><span style=color:#cdd6f4>.</span><span style=color:#b4befe>stringify</span><span style=color:#cdd6f4>(</span><span style=color:#b4befe>countUtxos</span><span style=color:#cdd6f4>,</span> <span style=color:#cba6f7;font-style:italic>null</span><span style=color:#cdd6f4>,</span> 2<span style=color:#cdd6f4>))</span>
</span></span></code></pre></div><p>Decoding resultant datum confirms that our updated count spending validator works! Now, if other contracts wanted to leverage this &ldquo;count&rdquo; value, they can do so, knowing that its integrity will remain intact.</p><h2 id=whats-next>What&rsquo;s Next?</h2><p>Now that we understand the relationship between minting policies and spending validators, we can use these primitives to start composing decentralized, trustless protocols on top of Cardano! Please reach out to me on GitHub or Discord if this content was helpful for you or you would like to read more posts like it. Are there other Aiken or Cardano topics you&rsquo;d like explored? Let me know!</p><hr><p>Homework:</p><ol><li><p>The count spending validator <a href=https://github.com/Piefayth/aiken-blog-1-code/blob/main/validators/secure_count.ak#L54-L59>assumes that there is only a single count being updated</a>. Modify the validator and the transaction that calls it to support updating multiple count datums at once.</p></li><li><p>The minting policy for the authorizing NFTs leveraged by the count spending validator <a href=https://github.com/Piefayth/aiken-blog-1-code/blob/main/validators/secure_count.ak#L102>disallows updates of existing count data during transactions that include a mint</a>. Modify the validator to support doing both in one transaction. What needs to change for you to be able to identify which output belongs with which input (if any)?</p></li></ol></div></article></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/piefayth target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://discord.com/users/piefayth target=_blank rel="noopener noreferrer me" title=Discord><svg xmlns="http://www.w3.org/2000/svg" viewBox="20 15 205 190" fill="currentcolor" stroke="none"><path d="M104.4 103.9c-5.7.0-10.2 5-10.2 11.1s4.6 11.1 10.2 11.1c5.7.0 10.2-5 10.2-11.1.1-6.1-4.5-11.1-10.2-11.1zm36.5.0c-5.7.0-10.2 5-10.2 11.1s4.6 11.1 10.2 11.1c5.7.0 10.2-5 10.2-11.1s-4.5-11.1-10.2-11.1z"/><path d="M189.5 20h-134C44.2 20 35 29.2 35 40.6v135.2c0 11.4 9.2 20.6 20.5 20.6h113.4l-5.3-18.5 12.8 11.9 12.1 11.2 21.5 19V40.6c0-11.4-9.2-20.6-20.5-20.6zm-38.6 130.6s-3.6-4.3-6.6-8.1c13.1-3.7 18.1-11.9 18.1-11.9-4.1 2.7-8 4.6-11.5 5.9-5 2.1-9.8 3.5-14.5 4.3-9.6 1.8-18.4 1.3-25.9-.1-5.7-1.1-10.6-2.7-14.7-4.3-2.3-.9-4.8-2-7.3-3.4-.3-.2-.6-.3-.9-.5-.2-.1-.3-.2-.4-.3-1.8-1-2.8-1.7-2.8-1.7s4.8 8 17.5 11.8c-3 3.8-6.7 8.3-6.7 8.3-22.1-.7-30.5-15.2-30.5-15.2.0-32.2 14.4-58.3 14.4-58.3 14.4-10.8 28.1-10.5 28.1-10.5l1 1.2c-18 5.2-26.3 13.1-26.3 13.1s2.2-1.2 5.9-2.9c10.7-4.7 19.2-6 22.7-6.3.6-.1 1.1-.2 1.7-.2 6.1-.8 13-1 20.2-.2 9.5 1.1 19.7 3.9 30.1 9.6.0.0-7.9-7.5-24.9-12.7l1.4-1.6s13.7-.3 28.1 10.5c0 0 14.4 26.1 14.4 58.3.0.0-8.5 14.5-30.6 15.2z"/></svg></a></div><small class=footer_copyright> 2023 .
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel="noreferrer noopener">Hugo blog awesome</a>
theme on
<a href=https://gohugo.io target=_blank rel="noreferrer noopener">Hugo</a>.</small></footer><script src=https://piefayth.github.io/blog/js/main.min.4ee188e1744c19816e95a540b2650ed9f033ea0371e74eac8e717355cfca8741.js integrity="sha256-TuGI4XRMGYFulaVAsmUO2fAz6gNx506sjnFzVc/Kh0E="></script></body></html>